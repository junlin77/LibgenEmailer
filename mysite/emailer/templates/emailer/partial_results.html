{% load static %}
<div class="results">
    <table>
        <thead>
            <tr>
                <th>Author</th>
                <th>Title</th>
                <th>Publisher</th>
                <th>Year</th>
                <th>Pages</th>
                <th>Language</th>
                <th>Size</th>
                <th>Extension</th>
                <th>Send!</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr>
                <td>{{ book.Author }}</td>
                <td>{{ book.Title }}</td>
                <td>{{ book.Publisher }}</td>
                <td>{{ book.Year }}</td>
                <td>{{ book.Pages }}</td>
                <td>{{ book.Language }}</td>
                <td>{{ book.Size }}</td>
                <td>{{ book.Extension }}</td>
                <td class="table-button">
                    <form class="sending-form" action="{% url 'send_to_kindle' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="book_to_download" value="{{ book }}">
                        <input type="hidden" name="kindle_email" id="kindleEmailInput">
                        <button type="submit" class="btn btn-primary send-button">
                            <img src="{% static 'images/airplane.svg' %}" alt="Send" width="35" height="35">
                        </button>
                        <div class="loader-container">
                            <span class="loader"></span>
                        </div>
                    </form>                                                      
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>  
<script>
    $(document).ready(function() {
            $('.sending-form').submit(function(e) {
                e.preventDefault(); // Prevent form submission
                var form = $(this);
                var button = form.find('.send-button');
                var loader = form.find('.loader');

                // Disable the button and show the loader
                button.attr("disabled", true);
                loader.show();
                button.hide();

                $.ajax({
                    url: form.attr('action'),
                    type: form.attr('method'),
                    data: form.serialize(),
                    success: function(response) {
                        if (response.success) {
                            swal("Success!", "Email sent successfully.", "success");
                        } else if (response == "Invalid email address.") {
                            swal("Error!", "Please input correct email format.", "error");
                        } else {
                            swal("Error!", "Failed to send the email.", "error");
                        }
                    },
                    error: function() {
                        swal("Error!", "An error occurred.", "error");
                    },
                    complete: function() {
                        // Re-enable the button and hide the loader whether success or failure
                        button.attr("disabled", false);
                        loader.hide();
                        button.show();
                    }
                });
            });
        });

        // Set the sending form email input value
        var storedKindleEmail = localStorage.getItem('kindle_email');
        var kindleEmailInputs = document.querySelectorAll('input[id="kindleEmailInput"]');
        
        kindleEmailInputs.forEach(function(input) {
            input.value = storedKindleEmail;
        });
</script>        
