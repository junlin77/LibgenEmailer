{% load static %}
<div class="results">
    <table class="full-size">
        <thead>
            <tr>
                <th>Author</th>
                <th>Title</th>
                <th>Publisher</th>
                <th>Year</th>
                <th>Pages</th>
                <th>Language</th>
                <th>Size</th>
                <th>Extension</th>
                <th>Send!</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr>
                <td>{{ book.Author }}</td>
                <td>{{ book.Title }}</td>
                <td>{{ book.Publisher }}</td>
                <td>{{ book.Year }}</td>
                <td>{{ book.Pages }}</td>
                <td>{{ book.Language }}</td>
                <td>{{ book.Size }}</td>
                <td>{{ book.Extension }}</td>
                <td class="table-button">
                    <form class="sending-form" action="{% url 'send_to_kindle' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="book_to_download" value="{{ book }}">
                        <input type="hidden" name="kindle_email" id="kindleEmailInput">
                        <button type="submit" class="btn btn-primary send-button">
                            <img src="{% static 'images/airplane.svg' %}" alt="Send" width="35" height="35">
                        </button>
                        <div class="loader-container">
                            <span class="loader"></span>
                        </div>
                    </form>                                                      
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <table class="mobile">
        <thead>
            <tr>
                <th>Author</th>
                <th>Title</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr class="table-row">
                <td>{{ book.Author }}</td>
                <td>{{ book.Title }}</td>
                <input type="hidden" class="hidden-details" value="Publisher: {{ book.Publisher }}|Year :{{ book.Year }}|Pages :{{ book.Pages }}|Language: {{ book.Language }}|Size: {{ book.Size }}|Extension: {{ book.Extension }}">
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-details"></div>
            <form class="sending-form" action="{% url 'send_to_kindle' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="book_to_download">
                <input type="hidden" name="kindle_email" id="kindleEmailInput">
                <button type="submit" class="btn btn-primary send-button">
                    <img src="{% static 'images/airplane.svg' %}" alt="Send" width="35" height="35">
                </button>
                <div class="loader-container">
                    <span class="loader"></span>
                </div>
            </form>
        </div>
    </div>
</div>  
<script>
    $(document).ready(function() {
            $('.sending-form').submit(function(e) {
                e.preventDefault(); // Prevent form submission
                var form = $(this);
                var button = form.find('.send-button');
                var loader = form.find('.loader');

                // Disable the button and show the loader
                button.attr("disabled", true);
                loader.show();
                button.hide();

                $.ajax({
                    url: form.attr('action'),
                    type: form.attr('method'),
                    data: form.serialize(),
                    success: function(response) {
                        if (response.success) {
                            var email = form.find('#kindleEmailInput').val();
                            swal("Success!", "Sent successfully to: " + email, "success");
                        } else if (response == "Invalid email address.") {
                            swal("Error!", "Please input correct email format.", "error");
                        } else {
                            swal("Oops!", "There's been an error :(", "error");
                        }
                    },
                    error: function() {
                        swal("Error!", "An error occurred.", "error");
                    },
                    complete: function() {
                        // Re-enable the button and hide the loader whether success or failure
                        button.attr("disabled", false);
                        loader.hide();
                        button.show();
                    }
                });
            });
        });

    // Set the sending form email input value
    var storedKindleEmail = localStorage.getItem('kindle_email');
    var kindleEmailInputs = document.querySelectorAll('input[id="kindleEmailInput"]');
    
    kindleEmailInputs.forEach(function(input) {
        input.value = storedKindleEmail;
    });

    // Mobile table click event
    var tableRows = document.querySelectorAll(".table-row");
    var modal = document.getElementById("modal");
    var modalDetails = modal.querySelector(".modal-details");
    var closeBtn = modal.querySelector(".close");
    var bookToDownloadInput = modal.querySelector("input[name='book_to_download']");
    var kindleEmailInput = modal.querySelector("#kindleEmailInput");

    tableRows.forEach(function(row) {
        row.addEventListener("click", function() {
            var hiddenDetails = row.querySelector(".hidden-details").value;
            var detailsArray = hiddenDetails.split("|");
            var detailsHtml = "";

            // Construct the HTML for the details
            detailsArray.forEach(function(detail) {
                detailsHtml += "<p>" + detail + "</p>";
            });

            modalDetails.innerHTML = detailsHtml;

            // Set the book_to_download input value to the book's hidden details
            bookToDownloadInput.value = hiddenDetails;

            // Display the modal
            modal.style.display = "block";
        });
    });

    // Close the modal when the close button is clicked
    closeBtn.addEventListener("click", function() {
        modal.style.display = "none";
    });

    // Close the modal when clicking outside the modal content
    window.addEventListener("click", function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    });
</script>        
